<ProtelObjects>

  <Author>David Francis Parinussa | Mikrotik Amalatu</Author>
  <Version>0.05</Version>
  <Comment>
    /**
			V 0.05
			* Added CC Auth Code & Amount

			V 0.04
			* Improved query optimization

			V 0.03
			* Added function to remove unknown records
			* Fixed Navigator's init issue

			V 0.02
			* Added Pickup/Dropoff package
			* Added fixed split table @ArrPackage and @DepPackage
			* Fixed Room Sharer and Room Move issue  

			V 0.01
			* Added condition for initialization
    **/
  </Comment>
  
  <ProtelObject>
    <Class>MessageBox</Class>
    <Name>XND_UDF_Data_ModuleInfo</Name>
    <Hook>HOOK_SYSTEMDATA</Hook>
    <Title>XND UDF Data - Module Info</Title>
    <Icon>53</Icon>
    <Text>UDF_Data V 0.05 by XNDubai Team</Text>
  </ProtelObject>

  <ProtelObject>
    <Class>Container</Class>
    <Name>XND_UDF_Data_Init</Name>
    <Hook>HOOK_SYSTEMDATA</Hook>
    <Title>XND UDF Data - Init</Title>
    <Icon>79</Icon>
    <Execute>XND_UDF_Data_Init_Query</Execute>
  </ProtelObject>

  <ProtelObject>
    <Class>SQLQuery</Class>
    <Hook>HOOK_NONE</Hook>
    <Name>XND_UDF_Data_Init_Query</Name>
    <Icon>71</Icon>
    <GenerateType>SQL</GenerateType>
  	<GaugeText>Initializing UDF Data</GaugeText>
    <Query>
			/**
			Define Pickup/Dropoff Packages' reference (splittab.stabnr).
			There are 2 of them 'Dynamic' & 'Fixed'
			
			You can use the Fixed one by putting splittab.stabnr into the arrays or using the Dynamic one by selecting splittab.stabnr using like operator.
			For the Dynamic one, please make sure the Pickup/Dropoff Packages must contains ARR or DEP. ARR stands for Arrival, while DEP stands for Departure.

			Dynamic e.g
				... where bucharr.arrange in(select stabnr from splittab where bez like '%ARR%')
				... where bucharr.arrange in(select stabnr from splittab where bez like '%DEP%')

			Fixed e.g
				... where bucharr.arrange in(select stabnr from @ArrPackages)
				... where bucharr.arrange in(select stabnr from @DepPackages)

			By default Dynamic one is used. You can uncomment the Fixed one below and change the query to use them. 
			**/

			--declare @ArrPackages table (stabnr int), @DepPackages table (stabnr int);
			--insert @ArrPackages(stabnr) values(35),(36),(37)(42),(45),(51),(54);
			--insert @DepPackages(stabnr) values(18),(30),(34)(43),(44),(53);
 
			if (object_id('xndudfdata') is null)
        begin
          create table xndudfdata
          (
            "modifieddate" datetime,
		        "resno" int not null,
            "arrflightdate" datetime default '1900-01-01 00:00:00',
            "arrflightno" varchar(20) default '',
            "arrflighttime" varchar(5) default '  :  ',
            "arrflightairport" varchar(50) default '',
            "arrflightcar" varchar(50) default '',
            "arrflightremarks" varchar(200) default '',
            "arrpickuppackage" varchar(50) default '',
            "depflightdate" datetime default '1900-01-01 00:00:00',
            "depflightno" varchar(20) default '',
            "depflighttime" varchar(5) default '  :  ',
            "depflightairport" varchar(50) default '',
            "depflightcar" varchar(50) default '',            
            "depflightremarks" varchar(200) default '',
            "depdropoffpackage" varchar(50) default '',
						"ccauthcode" varchar(6) default '',
						"ccauthamount" decimal(10, 3)
          )
          create nonclustered index idx_resno on xndudfdata (resno);
        end
      
      if (not exists(select 1 from xndudfdata where modifieddate = '{PDate}')) 
        begin
					set ansi_warnings off;

				  with Bookings as
				  (
				  	select
	            ResNo = buch.leistacc,
							ArrFlightDate =
								max
								(
									case metadata.xkey
										when 'arr_flight_date' then
											metadata.data
									end
								),
							ArrFlightTime =
								max
								(
									case metadata.xkey
										when 'arr_flight_time' then
											metadata.data
									end
								),
							ArrFlightNo =
								max
								(
									case metadata.xkey
										when 'arr_flight_num' then
											metadata.data
									end
								),
							ArrFlightAirport =
								(
									select
										text
									from
										metacodes
									where
										ref =
											max
											(
												case metadata.xkey
													when 'arr_flight_airport' then
														metadata.data
												end
											)
								),
							ArrPickupTime =
								max
								(
									case metadata.xkey
										when 'arr_pickup_time' then
											metadata.data
									end
								),
							ArrFlightCar =
								(
									select
										text
									from
										metacodes
									where
										ref =
											max
											(
												case metadata.xkey
													when 'arr_flight_car' then
														metadata.data
												end
											)
								),
							ArrFlightRemarks =
								max
								(
									case metadata.xkey
										when 'arr_flight_remarks' then
											metadata.data
									end
								),
							DepFlightDate =
								max
								(
									case metadata.xkey
										when 'dep_flight_date' then
											metadata.data
									end
								),
							DepFlightTime =
								max
								(
									case metadata.xkey
										when 'dep_flight_time' then
											metadata.data
									end
								),
							DepFlightNo =
								max
								(
									case metadata.xkey
										when 'dep_flight_num' then
											metadata.data
									end
								),
							DepFlightAirport =
								(
									select
										text
									from
										metacodes
									where
										ref =
											max
											(
												case metadata.xkey
													when 'dep_flight_airport' then
														metadata.data
												end
											)
								),
							DepPickupTime =
								max
								(
									case metadata.xkey
										when 'dep_pickup_time' then
											metadata.data
									end
								),
							DepFlightCar =
								(
									select
										text
									from
										metacodes
									where
										ref =
											max
											(
												case metadata.xkey
													when 'dep_flight_car' then
														metadata.data
												end
											)
								),
							DepFlightRemarks =
								max
								(
									case metadata.xkey
										when 'dep_flight_remarks' then
											metadata.data
									end
								),
							CCAuthCode =
								max
								(
									case metadata.xkey
										when 'cc_auth_code' then
											metadata.data
									end
								),
							CCAuthAmount =
								max
								(
									case metadata.xkey
										when 'cc_auth_amount' then
											metadata.data
									end
								)
            from
	            buch
							inner join kat on kat.katnr = buch.katnr
							left join zimmer on zimmer.zinr = buch.zimmernr
							left join metadata on metadata.ref = buch.leistacc
		        where
							buch.buchstatus <= 1
			        and buch.reschar <= 1
							and (buch.datumvon >= '{PDate}' or buch.datumvon <= '{PDate}' and buch.datumbis >= '{PDate}')
			        and buch.mpehotel = {MPEHotel}
							and kat.zimmer = 1
							and
							(
								buch.sharenr = buch.buchnr or buch.sharenr = -1
								and buch.globbnr = -1 or buch.umzdurch = 1
								and buch.sharenr = buch.leistacc
							)
						group by buch.leistacc
					),
					ArrPickupPackage as
		  		(
						select
							ResNo = buch.leistacc,
							Data = splittab.bez
						from
							buch
							left join bucharr on bucharr.lgbuchnr = buch.leistacc
							left join splittab on splittab.stabnr = bucharr.arrange
						where
							bucharr.arrange in(select stabnr from splittab where bez like '%ARR%')
		  		),
					DepDropoffPackage as
		  		(
						select
							ResNo = buch.leistacc,
							Data = splittab.bez
						from
							buch
							left join bucharr on bucharr.lgbuchnr = buch.leistacc
							left join splittab on splittab.stabnr = bucharr.arrange
						where
							bucharr.arrange in(select stabnr from splittab where bez like '%DEP%')
		  		)
					insert into xndudfdata
						select
							'{PDate}',
							Bookings.ResNo,
							isnull(ArrFlightDate, '1900-01-01 00:00:00'),
							isnull(ArrFlightNo, ''),
							isnull(ArrFlightTime, '  :  '),
							isnull(ArrFlightAirport, ''),
							isnull(ArrFlightCar, ''),
							isnull(ArrFlightRemarks, ''),
							isnull(ArrPickupPackage.Data, ''),
							isnull(DepFlightDate, '1900-01-01 00:00:00'),
							isnull(DepFlightNo, ''),
							isnull(DepFlightTime, '  :  '),
							isnull(DepFlightAirport, ''),
							isnull(DepFlightCar, ''),
							isnull(DepFlightRemarks, ''),
							isnull(DepDropoffPackage.Data, ''),
							isnull(CCAuthCode, ''),
							isnull(CCAuthAmount, 0.000)
						from
							Bookings
							left join ArrPickupPackage on ArrPickupPackage.ResNo = Bookings.ResNo
						 	left join DepDropoffPackage on DepDropoffPackage.ResNo = Bookings.ResNo
						where
							(
						 		ArrFlightDate is not null
						 		and ArrFlightDate <> '1900-01-01 00:00:00'
							)
					 		or
							(
								DepFlightDate is not null
								and DepFlightDate <> '1900-01-01 00:00:00'
							)
							or
							(
								CCAuthCode is not null
							)
					 	order by
						 	Bookings.ResNo;
						
						set ansi_warnings on;
        end
      else
        select 1 as ResNo;
      
    </Query>
    <OnExit>
      <Execute>XND_UDF_Data_Condition</Execute>
    </OnExit>
  </ProtelObject>

  <ProtelObject>
    <Class>Condition</Class>
    <Name>XND_UDF_Data_Condition</Name>
    <Hook>HOOK_NONE</Hook>
    <Expression>{XND_UDF_Data_Init_Query.ResNo.1}</Expression>
    <Case>
      <When>1</When>
      <Then>
        <Execute>XND_UDF_Data_InitDataExist</Execute>
      </Then>
    </Case>
    <Default>
      <Execute>XND_UDF_Data_InitInfo</Execute>
    </Default>
  </ProtelObject>  

  <ProtelObject>
    <Class>MessageBox</Class>
    <Name>XND_UDF_Data_InitInfo</Name>
    <Hook>HOOK_NONE</Hook>
    <Icon>53</Icon>
		<Text>Initialization Completed! We're good to go :)</Text>
  </ProtelObject>

  <ProtelObject>
    <Class>MessageBox</Class>
    <Name>XND_UDF_Data_InitDataExist</Name>
    <Hook>HOOK_NONE</Hook>
    <Icon>53</Icon>
    <Text>The UDF Data already initialized!</Text>
  </ProtelObject>

  <ProtelObject>
    <Class>Container</Class>
    <Name>XND_UDF_Data_Nav_Init</Name>
    <Hook>HOOK_NAVIGATOR_INIT</Hook>
    <Icon>79</Icon>
  </ProtelObject>

  <ProtelObject>
    <Class>Container</Class>
    <Name>XND_UDF_Data_Changed</Name>
    <Hook>HOOK_PROFILES_UDF_EDITED</Hook>
    <Icon>30</Icon>
		<Execute>XND_UDF_Data_Changed_Query</Execute>
  </ProtelObject>

  <ProtelObject>
    <Class>SQLQuery</Class>
    <Hook>HOOK_NONE</Hook>
    <Name>XND_UDF_Data_Changed_Query</Name>
    <Icon>71</Icon>
    <Query>
      declare @MPEHotel int, @PDate datetime
      set nocount on;
			set ansi_warnings off;

      set @MPEHotel = {MPEHotel};
      set @PDate = '{PDate}';
      
      if (exists(select 1 from xndudfdata where resno = {XND_UDF_Data_Nav_Init.ResNo} and modifieddate = @PDate))
				begin
				  with Bookings as
				  (
				  	select
	            ResNo = buch.leistacc,
							ArrFlightDate =
								max
								(
									case metadata.xkey
										when 'arr_flight_date' then
											metadata.data
									end
								),
							ArrFlightTime =
								max
								(
									case metadata.xkey
										when 'arr_flight_time' then
											metadata.data
									end
								),
							ArrFlightNo =
								max
								(
									case metadata.xkey
										when 'arr_flight_num' then
											metadata.data
									end
								),
							ArrFlightAirport =
								(
									select
										text
									from
										metacodes
									where
										ref =
											max
											(
												case metadata.xkey
													when 'arr_flight_airport' then
														metadata.data
												end
											)
								),
							ArrPickupTime =
								max
								(
									case metadata.xkey
										when 'arr_pickup_time' then
											metadata.data
									end
								),
							ArrFlightCar =
								(
									select
										text
									from
										metacodes
									where
										ref =
											max
											(
												case metadata.xkey
													when 'arr_flight_car' then
														metadata.data
												end
											)
								),
							ArrFlightRemarks =
								max
								(
									case metadata.xkey
										when 'arr_flight_remarks' then
											metadata.data
									end
								),
							DepFlightDate =
								max
								(
									case metadata.xkey
										when 'dep_flight_date' then
											metadata.data
									end
								),
							DepFlightTime =
								max
								(
									case metadata.xkey
										when 'dep_flight_time' then
											metadata.data
									end
								),
							DepFlightNo =
								max
								(
									case metadata.xkey
										when 'dep_flight_num' then
											metadata.data
									end
								),
							DepFlightAirport =
								(
									select
										text
									from
										metacodes
									where
										ref =
											max
											(
												case metadata.xkey
													when 'dep_flight_airport' then
														metadata.data
												end
											)
								),
							DepPickupTime =
								max
								(
									case metadata.xkey
										when 'dep_pickup_time' then
											metadata.data
									end
								),
							DepFlightCar =
								(
									select
										text
									from
										metacodes
									where
										ref =
											max
											(
												case metadata.xkey
													when 'dep_flight_car' then
														metadata.data
												end
											)
								),
							DepFlightRemarks =
								max
								(
									case metadata.xkey
										when 'dep_flight_remarks' then
											metadata.data
									end
								),
							CCAuthCode =
								max
								(
									case metadata.xkey
										when 'cc_auth_code' then
											metadata.data
									end
								),
							CCAuthAmount =
								max
								(
									case metadata.xkey
										when 'cc_auth_amount' then
											metadata.data
									end
								)								
            from
	            buch
							inner join kat on kat.katnr = buch.katnr
							left join zimmer on zimmer.zinr = buch.zimmernr
							left join metadata on metadata.ref = buch.leistacc
		        where
							buch.leistacc = {XND_UDF_Data_Nav_Init.ResNo}
						group by buch.leistacc
					),
					ArrPickupPackage as
		  		(
						select
							ResNo = buch.leistacc,
							Data = splittab.bez
						from
							buch
							left join bucharr on bucharr.lgbuchnr = buch.leistacc
							left join splittab on splittab.stabnr = bucharr.arrange
						where
							bucharr.arrange in(select stabnr from splittab where bez like '%ARR%')
		  		),
					DepDropoffPackage as
		  		(
						select
							ResNo = buch.leistacc,
							Data = splittab.bez
						from
							buch
							left join bucharr on bucharr.lgbuchnr = buch.leistacc
							left join splittab on splittab.stabnr = bucharr.arrange
						where
							bucharr.arrange in(select stabnr from splittab where bez like '%DEP%')
		  		)
			  	update xndudfdata
						set
							modifieddate = @PDate,
							resno = Bookings.ResNo,
							arrflightdate = isnull(Bookings.ArrFlightDate, '1900-01-01 00:00:00'),
							arrflightno = isnull(Bookings.ArrFlightNo, ''),
							arrflighttime = isnull(Bookings.ArrFlightTime, '  :  '),
							arrflightairport = isnull(Bookings.ArrFlightAirport, ''),
							arrflightcar = isnull(Bookings.ArrFlightCar, ''),
							arrflightremarks = isnull(Bookings.ArrFlightRemarks, ''),
							arrpickuppackage = isnull(ArrPickupPackage.Data, ''),
							depflightdate = isnull(Bookings.DepFlightDate, '1900-01-01 00:00:00'),
							depflightno = isnull(Bookings.DepFlightNo, ''),
							depflighttime = isnull(Bookings.DepFlightTime, '  :  '),
							depflightairport = isnull(Bookings.DepFlightAirport, ''),
							depflightcar = isnull(Bookings.DepFlightCar, ''),
							depflightremarks = isnull(Bookings.DepFlightRemarks, ''),
							depdropoffpackage = isnull(DepDropoffPackage.Data, ''),
							ccauthcode = isnull(Bookings.CCAuthCode, ''),
							ccauthamount = isnull(Bookings.CCAuthAmount, 0.000)
						from
							Bookings
							left join ArrPickupPackage on ArrPickupPackage.ResNo = Bookings.ResNo
						 	left join DepDropoffPackage on DepDropoffPackage.ResNo = Bookings.ResNo
						where
							xndudfdata.resno = {XND_UDF_Data_Nav_Init.ResNo}
				end
      else
				begin
				  with Bookings as
				  (
				  	select
	            ResNo = buch.leistacc,
							ArrFlightDate =
								max
								(
									case metadata.xkey
										when 'arr_flight_date' then
											metadata.data
									end
								),
							ArrFlightTime =
								max
								(
									case metadata.xkey
										when 'arr_flight_time' then
											metadata.data
									end
								),
							ArrFlightNo =
								max
								(
									case metadata.xkey
										when 'arr_flight_num' then
											metadata.data
									end
								),
							ArrFlightAirport =
								(
									select
										text
									from
										metacodes
									where
										ref =
											max
											(
												case metadata.xkey
													when 'arr_flight_airport' then
														metadata.data
												end
											)
								),
							ArrPickupTime =
								max
								(
									case metadata.xkey
										when 'arr_pickup_time' then
											metadata.data
									end
								),
							ArrFlightCar =
								(
									select
										text
									from
										metacodes
									where
										ref =
											max
											(
												case metadata.xkey
													when 'arr_flight_car' then
														metadata.data
												end
											)
								),
							ArrFlightRemarks =
								max
								(
									case metadata.xkey
										when 'arr_flight_remarks' then
											metadata.data
									end
								),
							DepFlightDate =
								max
								(
									case metadata.xkey
										when 'dep_flight_date' then
											metadata.data
									end
								),
							DepFlightTime =
								max
								(
									case metadata.xkey
										when 'dep_flight_time' then
											metadata.data
									end
								),
							DepFlightNo =
								max
								(
									case metadata.xkey
										when 'dep_flight_num' then
											metadata.data
									end
								),
							DepFlightAirport =
								(
									select
										text
									from
										metacodes
									where
										ref =
											max
											(
												case metadata.xkey
													when 'dep_flight_airport' then
														metadata.data
												end
											)
								),
							DepPickupTime =
								max
								(
									case metadata.xkey
										when 'dep_pickup_time' then
											metadata.data
									end
								),
							DepFlightCar =
								(
									select
										text
									from
										metacodes
									where
										ref =
											max
											(
												case metadata.xkey
													when 'dep_flight_car' then
														metadata.data
												end
											)
								),
							DepFlightRemarks =
								max
								(
									case metadata.xkey
										when 'dep_flight_remarks' then
											metadata.data
									end
								),
								CCAuthCode =
								max
								(
									case metadata.xkey
										when 'cc_auth_code' then
											metadata.data
									end
								),
							CCAuthAmount =
								max
								(
									case metadata.xkey
										when 'cc_auth_amount' then
											metadata.data
									end
								)
            from
	            buch
							inner join kat on kat.katnr = buch.katnr
							left join zimmer on zimmer.zinr = buch.zimmernr
							left join metadata on metadata.ref = buch.leistacc
		        where
							buch.leistacc = {XND_UDF_Data_Nav_Init.ResNo}
						group by buch.leistacc
					),
					ArrPickupPackage as
		  		(
						select
							ResNo = buch.leistacc,
							Data = splittab.bez
						from
							buch
							left join bucharr on bucharr.lgbuchnr = buch.leistacc
							left join splittab on splittab.stabnr = bucharr.arrange
						where
							bucharr.arrange in(select stabnr from splittab where bez like '%ARR%')
		  		),
					DepDropoffPackage as
		  		(
						select
							ResNo = buch.leistacc,
							Data = splittab.bez
						from
							buch
							left join bucharr on bucharr.lgbuchnr = buch.leistacc
							left join splittab on splittab.stabnr = bucharr.arrange
						where
							bucharr.arrange in(select stabnr from splittab where bez like '%DEP%')
		  		)
					insert into xndudfdata
		  			select
							'{PDate}',
							Bookings.ResNo,
							isnull(Bookings.ArrFlightDate, '1900-01-01 00:00:00'),
							isnull(Bookings.ArrFlightNo, ''),
							isnull(Bookings.ArrFlightTime, '  :  '),
							isnull(Bookings.ArrFlightAirport, ''),
							isnull(Bookings.ArrFlightCar, ''),
							isnull(Bookings.ArrFlightRemarks, ''),
							isnull(ArrPickupPackage.Data, ''),
							isnull(Bookings.DepFlightDate, '1900-01-01 00:00:00'),
							isnull(Bookings.DepFlightNo, ''),
							isnull(Bookings.DepFlightTime, '  :  '),
							isnull(Bookings.DepFlightAirport, ''),
							isnull(Bookings.DepFlightCar, ''),
							isnull(Bookings.DepFlightRemarks, ''),
							isnull(DepDropoffPackage.Data, ''),
							isnull(Bookings.CCAuthCode, ''),
							isnull(Bookings.CCAuthAmount, 0.000)
						from
							Bookings
							left join ArrPickupPackage on ArrPickupPackage.ResNo = Bookings.ResNo
						 	left join DepDropoffPackage on DepDropoffPackage.ResNo = Bookings.ResNo
				end
				
				set ansi_warnings on;
    </Query>
		<OnExit>
			<Execute>XND_UDF_Data_RemoveUnknown</Execute>
		</OnExit>
  </ProtelObject>

	<ProtelObject>
		<Class>SQLQuery</Class>
  	<Hook>HOOK_NONE</Hook>
  	<Name>XND_UDF_Data_RemoveUnknown</Name>
  	<Icon>71</Icon>
		<Query>
			/**
			Somehow the unknown data get inserted when the users change/modify other UDF fields.
			As this "HOOK_PROFILES_UDF_EDITED" will be called if one of the UDF field is clicked.
			The following query will remove those records.
			**/
			delete from xndudfdata
			where
			(
				arrflightdate = '01Jan1900' or arrflightno = ''
			)
			and
			(
				depflightdate = '01Jan1900' or depflightno = ''
			)
			and
			(
				ccauthcode = '' or ccauthamount = 0.000
			)

		</Query>
	</ProtelObject>

</ProtelObjects>
